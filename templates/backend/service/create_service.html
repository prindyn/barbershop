{% extends 'backend/base.html' %}

{% load static %}

{% block link %}

    {{ block.super }}

{% endblock %}

{% block content %}

    <div class="padding">
        <form role="form" action="{% url 'save-service' %}" data-url-success="{% url 'service-list' %}" method="post" enctype="multipart/form-data" novalidate>

            {% csrf_token %}

            <div class="form-row">
                <div class="form-group col-md-6">

                    {% for field in form %}

                        {% if field == 'image' %}

                            {% with template_name=field.name|stringformat:"s"|add:".html" %}

                                {% include 'forms/includes/'|add:template_name %}

                            {% endwith %}

                        {% elif field == 'icon '%}

                            {% with template_name=field.name|stringformat:"s"|add:".html" %}

                                {% include 'forms/includes/'|add:template_name %}

                            {% endwith %}



                        {% else %}

                            {% with template_name=field.name|stringformat:"s"|add:".html" %}

                                    {% include 'forms/includes/'|add:template_name %}

                                {% endwith %}

                        {% endif %}

                    {% endfor %}

                </div>
            </div>
            <button type="submit" class="btn primary">ZapisaÄ‡</button>
        </form>
    </div>

    <script>

        //script for show uploaded files
        var img_btn = $('.box-img').find('input'),
            icon_btn = $('.box-icon').find('input');

        img_btn.change(function (e) {
            var tmp_path = URL.createObjectURL(e.target.files[0]);
            $(this).closest('.box-img').find('img').fadeIn("fast").attr('src', tmp_path);
        });
        icon_btn.change(function (e) {
            var tmp_path = URL.createObjectURL(e.target.files[0]);
            $(this).closest('.box-icon').find('img').fadeIn("fast").attr('src', tmp_path);
        });

        //script for save new service
        $('form').submit(function(e){
            e.preventDefault();

            var formData = new FormData($(this)[0]);

            $.ajax({
                url: $(this).attr("action"),
                method: 'post',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response){
                    if(response.result > 0){
                        document.location.href = response.url_success;
                    }
                    if(response.result < 0){
                        show_error_message(response.message)
                    }
                }
            });
        });

        //script for generate slug
        function generate_slug(str) {
            var $slug = '';
            var trimmed = $.trim(str);
            $slug = trimmed.replace(/[^a-z0-9-]/gi, '-').
            replace(/-+/g, '-').
            replace(/^-|-$/g, '');
            return $slug.toLowerCase();
        }

        $('.js-slug-source').find('input').keyup(function(){
            $('.js-slug').find('input').val(generate_slug($(this).val()));
        });

        //functions to show service save errors
        function show_error_message(data){
            if(typeof data == 'string' || data instanceof String){
                showErrorToast(data);
            }
            else {
                var first = true;
                $.each(data, function (k, v) {
                    showErrorToast(v[0]);
                    first = false;
                    if (first === false) {
                        return false
                    }
                })
            }
        }
    </script>

{% endblock %}